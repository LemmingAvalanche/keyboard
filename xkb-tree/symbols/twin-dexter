default partial alphanumeric_keys
xkb_symbols "latin" {
    // Use caps lock and the key to the left of the return key (on
    // European (105) keyboards) to access the third level.
    include "level3(modifier_mapping)"
    include "level3(bksl_switch)"
    include "level3(caps_switch)"
    // Use right Alt as Alt key, instead of AltGr key.
    key <RALT> { [ Alt_R ] };

    // Make levels 5–8 possible.
    key.type[Group1] = "EIGHT_LEVEL";

    key <AD01> {
    // Make an explicit group so that we can use an `actions` section
    // (see below).
    symbols[Group1] = [
        q, Q, leftsinglequotemark, leftdoublequotemark,
        NoSymbol, NoSymbol, Control_L, Control_L
    ],
    actions[Group1] = [
        // Do not set any action for non-Extend layer keys.
        NoAction(), NoAction(), NoAction(), NoAction(),
        NoAction(), NoAction(),
        // We need to set appropriate actions for control keys.
        SetMods(mods=Control), SetMods(mods=Shift+Control)
    ]
    };
    key <AD02> { [
        w, W, rightsinglequotemark, rightdoublequotemark,
        NoSymbol, NoSymbol, NoSymbol, NoSymbol
    ] };
    // Duplicate commonly used symbols to third level of the alphabetic
    // section.
    key <AD03> { [
        e, E, percent, NoSymbol,
        NoSymbol, NoSymbol, XF86Back, XF86Back
    ] };
    key <AD04> { [
        r, R, ampersand, NoSymbol,
        NoSymbol, NoSymbol, XF86Forward, XF86Forward
    ] };
    key <AD05> { [
        t, T, bar, NoSymbol,
        NoSymbol, NoSymbol, NoSymbol, NoSymbol
    ] };
    key <AD06> { [
        y, Y, backslash, NoSymbol,
        NoSymbol, NoSymbol, Page_Up, Page_Up
    ] };
    key <AD07> { [
        u, U, grave, NoSymbol,
        NoSymbol, NoSymbol, Home, Home
    ] };
    key <AD08> { [
        i, I, equal, NoSymbol,
        NoSymbol, NoSymbol, Up, Up
    ] };
    key <AD09> { [
        o, O, question, NoSymbol,
        NoSymbol, NoSymbol, End, End
    ] };
    key <AD10> { [
        p, P, plus, NoSymbol,
        NoSymbol, NoSymbol, Delete, Delete
    ] };
    key <AC01> { [
        a, A, less, NoSymbol,
        NoSymbol, NoSymbol, Escape, Escape
    ] };
    key <AC02> { [
        s, S, greater, NoSymbol,
        NoSymbol, NoSymbol, ISO_First_Group, NoSymbol
    ] };
    key <AC03> { [
        d, D, exclam, NoSymbol,
        NoSymbol, NoSymbol, ISO_Prev_Group, NoSymbol
    ] };
    key <AC04> { [
        f, F, quotedbl, NoSymbol,
        NoSymbol, NoSymbol, ISO_Next_Group, NoSymbol
    ] };
    key <AC05> { [
        g, G, at, NoSymbol,
        NoSymbol, NoSymbol, ISO_Last_Group, NoSymbol
    ] };
    key <AC06> { [
        h, H, numbersign, NoSymbol,
        NoSymbol, NoSymbol, Page_Down, Page_Down
    ] };
    key <AC07> { [
        j, J, dollar, NoSymbol,
        NoSymbol, NoSymbol, Left, Left
    ] };
    key <AC08> { [
        k, K, apostrophe, NoSymbol,
        NoSymbol, NoSymbol, Down, Down
    ] };
    key <AC09> { [
        l, L, asterisk, NoSymbol,
        NoSymbol, NoSymbol, Right, Right
    ] };
};

// Common mappings for all “Norwegian” keymappings.
partial alphanumeric_keys
xkb_symbols "no-common" {
    // Norwegian characters
    key <AD11>	{ [
        aring, Aring, braceleft, NoSymbol,
        U030C, NoSymbol, NoSymbol, NoSymbol
    ] };
    key <AC10>	{ [
        oslash, Ooblique, parenleft, U301A,
        U0304, NoSymbol, BackSpace, BackSpace
    ] };
    key <AC11>	{ [
        ae, AE, parenright, U301B,
        U0306, NoSymbol, NoSymbol, NoSymbol
    ] };

    // Make ASCII symbols and other useful symbols available on the
    // alpbabetic section.
    //
    // For the “programming” keymappings, the Norwegian keys are used
    // (<AD11>, <AC10>, and <AC11>) to make certain symbols available on
    // the alpbabetic section.  So the displaced symbols need to get a
    // new home.
    key <AD12> { [
        asciicircum, asciitilde, braceright, NoSymbol,
        U0303, NoSymbol, Insert, Insert
    ] };
    key <AB05> { [
        b, B, bracketleft, U300C,
        0, NoSymbol, Pointer_Button1, Pointer_Button1
    ] };
    key <AB06> { [
        n, N, bracketright, U300D,
        NoSymbol, NoSymbol, Pointer_Button2, Pointer_Button2
    ] };
    key <AB07> { [
        m, M, slash, NoSymbol,
        NoSymbol, NoSymbol, Pointer_Button3, Pointer_Button3
    ] };
};

// “Esperanto common”.  Common keys for Esperanto-focused layouts,
// adopted from a Norwegian keyboard.
partial alphanumeric_keys
xkb_symbols "eo-common" {
    // Esperanto accents.
    //
    // These replaces the Norwegian characters, which are not used in
    // Esperanto.
    key <AC10>	{ [
        U0302, section, parenleft, U301A,
        U0304, NoSymbol, BackSpace, BackSpace
    ] };
    key <AC11>	{ [
        U016D, U016C, parenright, U301B,
        U0306, NoSymbol, NoSymbol, NoSymbol
    ] };
};

partial alphanumeric_keys
xkb_symbols "no" {
    include "no(basic)"
    include "twin-dexter(latin)"
    include "twin-dexter(no-common)"
};

partial alphanumeric_keys
xkb_symbols "no-nodeadkeys" {
    include "no(nodeadkeys)"
    include "twin-dexter(latin)"
    include "twin-dexter(no-common)"
};

partial alphanumeric_keys
xkb_symbols "no-p1" {
    include "twin-dexter(no-nodeadkeys)"

    // Make levels 5–8 possible.
    include "level5(modifier_mapping)"
    include "level5(lsgt_switch)"
    key.type[Group1] = "EIGHT_LEVEL";

    // Make the <TLDE> and <AE12> key into compose keys.
    key <TLDE> { type[Group1]="TWO_LEVEL", [ Multi_key, Multi_key ] };
    key <AE12> { type[Group1]="TWO_LEVEL", [ Multi_key, Multi_key ] };

    // Map Norwegian characters “æøå” to other symbols.  Useful when
    // programming (hence the name `no-p1`: the `p1` stands for
    // “programming 1”.  See also: [→1].
    key <AD11> { [
        slash, bar, U2044, NoSymbol,
        U030C, NoSymbol, NoSymbol, NoSymbol
    ] };
    key <AD12> { [
        asciicircum, asciitilde, U0302, NoSymbol,
        U0303, NoSymbol, Insert, Insert
    ] };

    // Keys <AC01> to <AC11> on this row contain diacritics on the
    // fifth level.
    key <AC01> { [
        a, A, less, U2329,
        U0304, NoSymbol, Escape, Escape
    ] };
    key <AC02> { [
        s, S, greater, U232A,
        U0308, NoSymbol, ISO_First_Group, NoSymbol
    ] };
    key <AC03> { [
        d, D, exclam, NoSymbol,
        U0302, NoSymbol, ISO_Prev_Group, NoSymbol
    ] };
    key <AC04> { [
        f, F, quotedbl, NoSymbol,
        U0301, NoSymbol, ISO_Next_Group, NoSymbol
    ] };
    key <AC05> { [
        g, G, at, NoSymbol,
        U0300, NoSymbol, ISO_Last_Group, NoSymbol
    ] };
    key <AC06> { [
        h, H, numbersign, leftarrow,
        U0300, NoSymbol, Page_Down, Page_Down
    ] };
    key <AC07> { [
        j, J, dollar, downarrow,
        U0301, NoSymbol, Left, Left
    ] };
    key <AC08> { [
        k, K, apostrophe, uparrow,
        U0302, NoSymbol, Down, Down
    ] };
    key <AC09> { [
        l, L, asterisk, rightarrow,
        U0308, NoSymbol, Right, Right
    ] };
    // →1
    key <AC10> { [
        parenleft, bracketleft, braceleft, U301A,
        U0304, NoSymbol, BackSpace, BackSpace
    ] };
    key <AC11> { [
        parenright, bracketright, braceright, U301B,
        U0306, NoSymbol, NoSymbol, NoSymbol
    ] };

    key <AB01> { [
        z, Z, guillemotleft, U2039,
        NoSymbol, NoSymbol, Undo, Redo
    ] };
    key <AB02> { [
        x, X, guillemotright, U203A,
        NoSymbol, NoSymbol, XF86Cut, XF86Cut
    ] };
    key <AB03> { [
        c, C, leftdoublequotemark, NoSymbol,
        NoSymbol, NoSymbol, XF86Copy, XF86Copy
    ] };
    key <AB04> { [
        v, V, rightdoublequotemark, NoSymbol,
        NoSymbol, NoSymbol, XF86Paste, XF86Paste
    ] };
    key <AB05> { [
        b, B, U300E, U300C,
        NoSymbol, NoSymbol, Pointer_Button1, Pointer_Button1
    ] };
    key <AB06> { [
        n, N, U300F, U300D,
        NoSymbol, NoSymbol, Pointer_Button2, Pointer_Button2
    ] };
    key <AB07> { [
        m, M, U25CA, NoSymbol,
        NoSymbol, NoSymbol, Pointer_Button3, Pointer_Button3
    ] };
    key <AB08> { [
        comma, semicolon, enfilledcircbullet, U2032,
        U0327, NoSymbol, NoSymbol, NoSymbol
    ] };
    key <AB09> { [
        period, colon, periodcentered, abovedot,
        U0307, NoSymbol, NoSymbol, NoSymbol
    ] };
    key <AB10> { [
        minus, underscore, endash, emdash,
        U0304, NoSymbol, NoSymbol, NoSymbol
    ] };
};

// Swap the right Win key and the menu key.
partial modifier_keys
xkb_symbols "swap_r_win_menu_key" {
    replace key <RWIN> { [ Multi_key ] };
    replace key <MENU> { [ Alt_R ] };
};

// Like `no-p1`, but with a new level 2 shift key and more convenient
// Alt keys.
partial alphanumeric_keys
xkb_symbols "no-p2" {
    include "twin-dexter(no-p1)"
    // Effectively “extend” the left shift key by mapping the key to the
    // right of it as another `Shift_L` key.  This makes it easier to
    // use shift together with left Alt (on the Windows key in this
    // mapping).
    key <LSGT> {
      [ Shift_L, Shift_L, Shift_L, Shift_L, Shift_L, Shift_L, Shift_L, Shift_L ]
    };
    include "altwin(swap_alt_win)"
    include "twin-dexter(swap_r_win_menu_key)"
    // Use this key to access the “numpad level”.
    key <RWIN> {
        [ ISO_Level5_Shift ]
    };
};

xkb_symbols "delete-group-switch" {
    key <DELE> { [ Delete, Delete, ISO_Next_Group ] };
};

// Make a “numpad”.
// This numpad has zero on the lowest right corner.  Comma and
// period are on the second and third row from the top, respectively.
xkb_symbols "alphabet-section-numpad" {
    // Set `EIGHT_LEVEL` in case it is necessary.
    key.type[Group1] = "EIGHT_LEVEL";
    // First (topmost) numpad row.
    key <AD02> { [
        w, W, rightsinglequotemark, rightdoublequotemark,
        7, NoSymbol, NoSymbol, NoSymbol
    ] };
    key <AD03> { [
        e, E, percent, NoSymbol,
        8, NoSymbol, XF86Back, XF86Back
    ] };
    key <AD04> { [
        r, R, ampersand, NoSymbol,
        9, NoSymbol, XF86Forward, XF86Forward
    ] };
    // Second numpad row.
    key <AC01> { [
        a, A, less, U2329, comma,
        NoSymbol, Escape, Escape
    ] };
    key <AC02> { [
        s, S, greater, U232A,
        4, NoSymbol, ISO_First_Group, NoSymbol
    ] };
    key <AC03> { [
        d, D, exclam, NoSymbol,
        5, NoSymbol, ISO_Prev_Group, NoSymbol
    ] };
    key <AC04> { [
        f, F, quotedbl, NoSymbol,
        6, NoSymbol, ISO_Next_Group, NoSymbol
    ] };
    // Third numpad row.
    key <AB01> { [
        z, Z, guillemotleft, U2039,
        period, NoSymbol, Undo, Redo
    ] };
    key <AB02> { [
        x, X, guillemotright, U203A,
        1, NoSymbol, XF86Cut, XF86Cut
    ] };
    key <AB03> { [
        c, C, leftdoublequotemark, NoSymbol,
        2, NoSymbol, XF86Copy, XF86Copy
    ] };
    key <AB04> { [
        v, V, rightdoublequotemark, NoSymbol,
        3, NoSymbol, XF86Paste, XF86Paste
    ] };
    key <AB05> { [
        b, B, U300E, U300C,
        0, NoSymbol, Pointer_Button1, Pointer_Button1
    ] };
};

// Fifth level keymappings.
//
// Numpad on the left side, combining characters on the right side.
xkb_symbols "numpad-and-combining" {
    include "twin-dexter(alphabet-section-numpad)"
    // Second row
    key <AC06> { [
        h, H, numbersign, leftarrow,
        U0300, NoSymbol, Page_Down, Page_Down
    ] };
    key <AC07> { [
        j, J, dollar, downarrow,
        U0301, NoSymbol, Left, Left
    ] };
    key <AC08> { [
        k, K, apostrophe, uparrow,
        U0302, NoSymbol, Down, Down
    ] };
    key <AC09> { [
        l, L, asterisk, rightarrow,
        U0308, NoSymbol, Right, Right
    ] };
    key <AC10> { [
        parenleft, bracketleft, braceleft, U301A,
        U0304, NoSymbol, BackSpace, BackSpace
    ] };
    key <AC11> { [
        parenright, bracketright, braceright, U301B,
        U0306, NoSymbol, NoSymbol, NoSymbol
    ] };
    // Third (bottom) row
    key <AB08> { [
        comma, semicolon, enfilledcircbullet, U2032,
        U0327, NoSymbol, NoSymbol, NoSymbol
    ] };
    key <AB09> { [
        period, colon, periodcentered, abovedot,
        U0307, NoSymbol, NoSymbol, NoSymbol
    ] };
    key <AB10> { [
        minus, underscore, endash, emdash,
        U0304, NoSymbol, NoSymbol, NoSymbol
    ] };
};

// Like `no-p2`, but with an “alphabetic numpad”.
xkb_symbols "no-p3" {
    include "twin-dexter(no-p2)"
    include "twin-dexter(delete-group-switch)"
    include "twin-dexter(alphabet-section-numpad)"
};

xkb_compat { include "level5" };

xkb_symbols "no-p4" {
    include "twin-dexter(no-p2)"
    include "twin-dexter(numpad-and-combining)"
    include "twin-dexter(delete-group-switch)"

    // For latches
    // Levels
    replace key <AE02> {
        type[Group1]="ONE_LEVEL",
        [ ISO_Level5_Latch ]
    };
    replace key <AE03> {
        type[Group1]="ONE_LEVEL",
        [ ISO_Level3_Latch ]
    };
    replace key <AE04> {
        type[Group1]="ONE_LEVEL",
        [ ISO_Level2_Latch ]
    };
    replace key <AE08> {
        type[Group1]="ONE_LEVEL",
        [ ISO_Level2_Latch ]
    };
    replace key <AE09> {
        type[Group1]="ONE_LEVEL",
        [ ISO_Level3_Latch ]
    };
    replace key <AE10> {
        type[Group1]="ONE_LEVEL",
        [ ISO_Level5_Latch ]
    };
    // compose
    replace key <AE05> {
        type[Group1]="ONE_LEVEL",
        [ Multi_key ]
    };
    replace key <AE07> {
        type[Group1]="ONE_LEVEL",
        [ Multi_key ]
    };
    // Menu key (right mouse click).
    replace key <AE06> {
        type[Group1]="ONE_LEVEL",
        [ Menu ]
    };
    // Hyper modifier
    // Need to map `<HYPR>` to `mod2` (by default mapped to `Numlock`),
    // or else it is mapped to the same modifier as the `Super` keys.
    modifier_map Mod2 { <HYPR>, <AE01>, <AE11> };
    replace key <AE01> {
        type[Group1]="ONE_LEVEL",
        [ Hyper_R ]
    };
    replace key <AE11> {
        type[Group1]="ONE_LEVEL",
        [ Hyper_L ]
    };

    // Modified Extend layer by way of a dead key.
    //
    // There are two symmetric keys, in the sense that they exist on
    // opposite sides of the keyboard to facilitate touch typing.
    //
    // This depends on the `~/.Xcompose` file which is maintained in the
    // dotfiles repository.  `~/.Xcompose` contains mappings which begin
    // with `<dead_greek>` like e.g. the following:
    //
    //     <dead_greek> <q> : Escape
    //
    // Which maps the sequence `<dead_greek> <q>` to the escape key.
    //
    // NOTE: The dead key mappings defined with these keys in my compose
    // file does not work in applications like Firefox, among others.
    // See: r#1a5af3d1f941 (“Add update about dead key mappings not
    // working”, 2017-08-31) in the dotfiles repository.
    replace key <TLDE> {
        [ dead_greek ]
    };
    replace key <AE12> {
        [ dead_greek ]
    };
};

// Norwegian version of `no-p4`.
xkb_symbols "no-4" {
    include "twin-dexter(no-p4)"
    include "twin-dexter(no-common)"
};

// Esperanto version of `no-p4`.
xkb_symbols "eo-4" {
    include "twin-dexter(no-p4)"
    include "twin-dexter(eo-common)"
};

xkb_symbols "no-p5" {
    include "twin-dexter(no-p4)"
    // Wean myself off using the `<AD12>` key by moving two of the
    // symbols to the `<AD11>` key.
    key <AD11> { [
        slash, asciicircum, asciitilde, NoSymbol,
        U030C, NoSymbol, NoSymbol, NoSymbol
    ] };
};
